<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="https://www.facebook.com/2008/fbml">
	<head>
		<title>Lunch Rabbit - Setup</title>
		<meta property="og:title" content="Lunch Rabbit" />
		<meta property="og:type" content="social" />
		<meta property="og:url" content="http://swdf.in2teck.com/" />
		
		<style type="text/css">
			#map-canvas {
				height: 500px;
				width:	800px;
			}
		</style>

		
	 	<!-- Include support librarys first -->
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="javascripts/jquery.json-2.3.min.js"></script>
		<script type="text/javascript" src="http://www.google.com/jsapi?autoload={'modules':[{name:'maps',version:3,other_params:'sensor=false'}]}"></script>
		
		<script type="text/javascript">
			var APP_ID = "316932864999658";	
			
			function registraUsuario() {
				var usuarioFB;
				var interests = [];
				FB.api('/me', function(response) {
					usuarioFB = response;
					$.getJSON("http://glowing-moon-5161.heroku.com/usuarios/encuentra_o_crea/" + usuarioFB.id + ".json", function(data) {
						data.usuario.nombre = usuarioFB.name;
						data.usuario.genero = usuarioFB.gender;
						data.usuario.email = usuarioFB.email;
						data.usuario.intereses = Array.new;
						data.usuario.thumbnail = "https://graph.facebook.com/" + usuarioFB.id + "/picture";
						
						FB.api('/me/likes', function(likes) {
							$.each(likes.data, function(index, value) { 
							  if (value.category == "Tv show" || value.category == "Musician/band" || value.category == "Movie" ||
									value.category == "Book" || value.category == "Interest") {
									interests.push({"facebook_id":value.id, "nombre":value.name, "categoria":value.category});
									//interests += '{"id":' + value.id + ', "nombre":' + value.name + ', "categoria":' + value.category +'}';
								}
							});
							data.intereses = $.toJSON(interests);
							$.post("http://glowing-moon-5161.heroku.com/usuarios/actualiza/" + usuarioFB.id + ".json", data, function(result) {
								alert('success');
							});
						});
					});
				});
			}
			
			function init() {
				var mapDiv = document.getElementById('map-canvas');
				var map = new google.maps.Map(mapDiv, {
					center: new google.maps.LatLng(37.790234970864, -122.39031314844),
					zoom: 8,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				});
				var distanceWidget = new DistanceWidget(map);
			}
		
			function DistanceWidget(map) {
				this.set('map', map);
				this.set('position', map.getCenter());

				var marker = new google.maps.Marker({
					draggable: true,
					title: 'Place me at your location'
				});
				// Bind the marker map property to the DistanceWidget map property
				marker.bindTo('map', this);
				// Bind the marker position property to the DistanceWidget position
				// property
				marker.bindTo('position', this);
				
				// Create a new radius widget
				var radiusWidget = new RadiusWidget();
				// Bind the radiusWidget map to the DistanceWidget map
				radiusWidget.bindTo('map', this);
				// Bind the radiusWidget center to the DistanceWidget position
				radiusWidget.bindTo('center', this, 'position');
				
				// Bind to the radiusWidgets' distance property
				this.bindTo('distance', radiusWidget);
				// Bind to the radiusWidgets' bounds property
				this.bindTo('bounds', radiusWidget);
			}	
			
			function RadiusWidget() {
				var circle = new google.maps.Circle({
					strokeWeight: 2
				});
				// Set the distance property value, default to 2km.
				this.set('distance', 3);
				// Bind the RadiusWidget bounds property to the circle bounds property.
				this.bindTo('bounds', circle);
				// Bind the circle center to the RadiusWidget center property
				circle.bindTo('center', this);
				// Bind the circle map to the RadiusWidget map
				circle.bindTo('map', this);
				// Bind the circle radius property to the RadiusWidget radius property
				circle.bindTo('radius', this);
				// Add the sizer marker
				this.addSizer_();
			}
			
			RadiusWidget.prototype = new google.maps.MVCObject();
			DistanceWidget.prototype = new google.maps.MVCObject();
			google.maps.event.addDomListener(window, 'load', init);
			
			/**
			 * Update the radius when the distance has changed.
			 */
			RadiusWidget.prototype.distance_changed = function() {
				this.set('radius', this.get('distance') * 1000);
			};
			
			/**
			 * Add the sizer marker to the map.
			 */
			RadiusWidget.prototype.addSizer_ = function() {
				var sizer = new google.maps.Marker({
					draggable: true,
					title: 'Increase/Decrease the radius'
				});

				sizer.bindTo('map', this);
				sizer.bindTo('position', this, 'sizer_position');
			};
			
			/**
			 * Update the center of the circle and position the sizer back on the line.
			 *
			 * Position is bound to the DistanceWidget so this is expected to change when
			 * the position of the distance widget is changed.
			 */
			RadiusWidget.prototype.center_changed = function() {
				var bounds = this.get('bounds');

				// Bounds might not always be set so check that it exists first.
				if (bounds) {
					var lng = bounds.getNorthEast().lng();

					// Put the sizer at center, right on the circle.
					var position = new google.maps.LatLng(this.get('center').lat(), lng);
					this.set('sizer_position', position);
				}
			};
			
			/**
			 * Calculates the distance between two latlng locations in km.
			 * @see http://www.movable-type.co.uk/scripts/latlong.html
			 *
			 * @param {google.maps.LatLng} p1 The first lat lng point.
			 * @param {google.maps.LatLng} p2 The second lat lng point.
			 * @return {number} The distance between the two points in km.
			 * @private
			*/
			RadiusWidget.prototype.distanceBetweenPoints_ = function(p1, p2) {
				if (!p1 || !p2) {
					return 0;
				}

				var R = 6371; // Radius of the Earth in km
				var dLat = (p2.lat() - p1.lat()) * Math.PI / 180;
				var dLon = (p2.lng() - p1.lng()) * Math.PI / 180;
				var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
					Math.cos(p1.lat() * Math.PI / 180) * Math.cos(p2.lat() * Math.PI / 180) *
					Math.sin(dLon / 2) * Math.sin(dLon / 2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
				var d = R * c;
				return d;
			};


			/**
			 * Set the distance of the circle based on the position of the sizer.
			 */
			RadiusWidget.prototype.setDistance = function() {
				// As the sizer is being dragged, its position changes.  Because the
				// RadiusWidget's sizer_position is bound to the sizer's position, it will
				// change as well.
				var pos = this.get('sizer_position');
				var center = this.get('center');
				var distance = this.distanceBetweenPoints_(center, pos);

				// Set the distance property for any objects that are bound to it
				this.set('distance', distance);
			};
			
			var me = this;
			google.maps.event.addListener(sizer, 'drag', function() {
				// Set the circle distance (radius)
				me.setDistance();
			});
			
			
		</script>
  </head>
  
	<body>
		<div id="fb-root"></div>
		<script type="text/javascript">
			window.fbAsyncInit = function() {
				FB.init({appId: APP_ID, status: true, cookie: true, xfbml: true});
				FB.getLoginStatus(function(response) {
						if (response.status == 'connected') {
							//registraUsuario();
						}
					});
			};
			(function() {
				var e = document.createElement('script');
				e.type = 'text/javascript';
				e.src = document.location.protocol +
					'//connect.facebook.net/en_US/all.js';
				e.async = true;
				document.getElementById('fb-root').appendChild(e);
			}());
		</script>
		
		<form>
			My lunch starts at: <select name="lunchStart">
							<option value="10">10:00</option>
							<option value="11">11:00</option>
							<option value="12">12:00</option>
							<option value="13">13:00</option>
							<option value="14">14:00</option>
							<option value="15">15:00</option>
							<option value="16">16:00</option>
							<option value="17">17:00</option>
							<option value="18">18:00</option>
						 </select>
			<br/><br/>
			My lunch ends at: <select name="lunchEnd">
							<option value="10">10:00</option>
							<option value="11">11:00</option>
							<option value="12">12:00</option>
							<option value="13">13:00</option>
							<option value="14">14:00</option>
							<option value="15">15:00</option>
							<option value="16">16:00</option>
							<option value="17">17:00</option>
							<option value="18">18:00</option>
						 </select> 
		</form>
		Select your location: <br/>
		<div id="map-canvas"></div>
	</body>
</html>
